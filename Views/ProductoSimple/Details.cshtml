@model BaseConLogin.Models.ProductoBase

@{
    ViewData["Title"] = Model.Nombre;
    var imagenes = Model.Imagenes.OrderByDescending(i => i.EsPrincipal).ToList();
    var urlRegreso = ViewBag.ReturnUrl ?? Url.Action("Index", "Home");

    // Lógica de migas de pan
    string origenTexto = "Inicio";
    string origenUrl = Url.Action("Index", "Home");
    if (!string.IsNullOrEmpty(urlRegreso))
    {
        if (urlRegreso.Contains("ProductoSimple")) { origenTexto = "Administración"; origenUrl = urlRegreso; }
        else if (urlRegreso.Contains("Search")) { origenTexto = "Búsqueda"; origenUrl = urlRegreso; }
    }

    decimal precioInicial = ViewBag.PrecioPartida ?? Model.PrecioBase;
}

<style>
    /* Estilo para resaltar visualmente la opción seleccionada */
    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd !important;
        color: white !important;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
        border-color: #0a58ca;
        transform: translateY(-2px);
    }

    .btn-opcion-label {
        transition: all 0.2s ease;
        border-width: 2px;
    }

    .main-img-container img {
        transition: opacity 0.3s ease;
    }

    .resumen-badge {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        background-color: #e9ecef;
        border-radius: 50px;
        color: #495057;
        display: inline-block;
    }
</style>

<div class="container mt-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-6 bg-light p-4">
                <div class="main-img-container shadow-sm rounded mb-3 bg-white text-center">
                    <img id="mainImage" src="@Model.ImagenPrincipal" alt="@Model.Nombre" class="img-fluid main-display" style="max-height: 500px;">
                </div>
                <div class="d-flex gap-2 justify-content-center overflow-auto pb-2">
                    @foreach (var img in imagenes)
                    {
                        <div class="thumb-container @(img.EsPrincipal ? "active" : "")">
                            <img src="/@img.Ruta" class="img-thumbnail thumb-img" onclick="changeImage(this.src, this)" role="button" style="width: 80px; height: 80px; object-fit: cover;">
                        </div>
                    }
                </div>
            </div>

            <div class="col-md-6 p-5 d-flex flex-column">
                <h1 class="display-5 fw-bold mb-3 text-dark">@Model.Nombre</h1>

                <div class="mb-4">
                    <span class="h2 fw-bold text-primary" id="precioDinamico" data-base="@precioInicial.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)">
                        @precioInicial.ToString("C2")
                    </span>
                    <span class="text-muted ms-2 small">IVA incluido</span>
                </div>

                <div class="opciones-configuracion">
                    @if (ViewBag.OpcionesCliente != null)
                    {
                        @foreach (var grupo in (IEnumerable<IGrouping<string, ProductoPropiedadConfigurada>>)ViewBag.OpcionesCliente)
                        {
                            <div class="opcion-grupo mb-4 p-3 rounded" id="contenedor_@grupo.Key.Replace(" ", "_")" style="background-color: #f8f9fa;">
                                <label class="fw-bold mb-3 text-secondary text-uppercase small d-block">
                                    <i class="fa-solid fa-gear me-2"></i>@grupo.Key
                                </label>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var opt in grupo)
                                    {
                                        <input type="radio" class="btn-check btn-opcion"
                                               name="grupo_@grupo.Key"
                                               id="opt_@opt.Id"
                                               data-valor="@opt.Valor.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                               data-op="@opt.Operacion"
                                               onchange="recalcularPrecio()"
                                               required>
                                        <label class="btn btn-outline-primary btn-opcion-label px-3 py-2" for="opt_@opt.Id">
                                            @opt.NombrePropiedad
                                            @if (opt.Valor > 0)
                                            {
                                                <span class="d-block small opacity-75">@(opt.Operacion == "Suma" ? "+" : "x") @opt.Valor.ToString("F2")€</span>
                                            }
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <div id="resumenSeleccion" class="mb-4 d-none">
                    <p class="small fw-bold text-muted mb-2">Tu selección:</p>
                    <div id="badgesSeleccionados" class="d-flex flex-wrap gap-2">
                    </div>
                </div>

                <p class="text-secondary mb-4 lh-lg">@Model.Descripcion</p>

                <div class="d-grid gap-2 d-md-flex mt-auto">
                    @if (Model.Stock > 0)
                    {
                        <form id="formAñadirCarrito" method="post" asp-controller="Carrito" asp-action="Añadir" class="w-100">
                            <input type="hidden" id="opcionesSeleccionadasInput" name="detallesOpciones" value="" />
                            <input type="hidden" name="productoBaseId" value="@Model.Id" />
                            <input type="hidden" name="tiendaId" value="@Model.TiendaId" />
                            <input type="hidden" id="precioFinalInput" name="precioCalculado" value="@precioInicial.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)" />

                            <div class="d-flex gap-2">
                                <div class="input-group" style="max-width: 150px;">
                                    <span class="input-group-text bg-white">Cant.</span>
                                    <input type="number" name="cantidad" value="1" min="1" max="@Model.Stock" class="form-control text-center" />
                                </div>
                                <button type="button" id="btnAñadirCarrito" class="btn btn-primary btn-lg flex-grow-1 shadow">
                                    <i class="fa-solid fa-cart-plus me-2"></i>Añadir al pedido
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <button class="btn btn-secondary btn-lg w-100" disabled>Sin stock disponible</button>
                    }
                </div>

                <a href="@urlRegreso" class="btn btn-link text-muted mt-4 p-0 text-decoration-none">
                    <i class="fa-solid fa-arrow-left me-1"></i> Volver a la lista
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function changeImage(src, element) {
            const mainImg = document.getElementById('mainImage');
            mainImg.style.opacity = '0';
            setTimeout(() => {
                mainImg.src = src;
                mainImg.style.opacity = '1';
            }, 200);
            document.querySelectorAll('.thumb-container').forEach(el => el.classList.remove('active'));
            element.parentElement.classList.add('active');
        }

        function recalcularPrecio() {
            const elPrecio = document.getElementById('precioDinamico');
            const inputFinal = document.getElementById('precioFinalInput');
            const inputOpciones = document.getElementById('opcionesSeleccionadasInput');
            const resumenContenedor = document.getElementById('resumenSeleccion');
            const badgesContenedor = document.getElementById('badgesSeleccionados');

            let total = parseFloat(elPrecio.getAttribute('data-base'));
            let textosElegidos = [];
            let htmlBadges = '';

            document.querySelectorAll('.btn-opcion:checked').forEach(radio => {
                const valor = parseFloat(radio.getAttribute('data-valor'));
                const op = radio.getAttribute('data-op');
                const nombreGrupo = radio.name.replace('grupo_', '');

                // Obtener texto limpio quitando el precio que está dentro del label
                const labelElement = document.querySelector(`label[for="${radio.id}"]`);
                const labelTexto = labelElement.childNodes[0].textContent.trim();

                textosElegidos.push(`${nombreGrupo}: ${labelTexto}`);

                // Crear badge visual
                htmlBadges += `<span class="resumen-badge shadow-sm border">
                                    <strong>${nombreGrupo}:</strong> ${labelTexto}
                               </span>`;

                // Cálculo matemático
                if (op === "Suma") total += valor;
                else if (op === "Multiplicacion") total *= valor;
                else if (op === "Resta") total -= valor;
            });

            // Actualizar vista
            const totalFormateado = total.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
            elPrecio.innerText = totalFormateado;

            if(inputFinal) inputFinal.value = total.toFixed(2);
            if(inputOpciones) inputOpciones.value = textosElegidos.join(', ');

            // Mostrar/Ocultar resumen de badges
            if (textosElegidos.length > 0) {
                resumenContenedor.classList.remove('d-none');
                badgesContenedor.innerHTML = htmlBadges;
            } else {
                resumenContenedor.classList.add('d-none');
            }
        }

        document.addEventListener('DOMContentLoaded', recalcularPrecio);

        $(document).ready(function () {
            $('#btnAñadirCarrito').on('click', function (e) {
                e.preventDefault(); // Evita que la página se recargue

                // Buscamos el formulario que envuelve al botón
                var $form = $(this).closest('form');

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(), // Envía todos los inputs (ID, cantidad, etc.)
                    success: function (response) {
                        // 1. Llamamos a la función del Layout para el pulso amarillo
                        if (typeof actualizarContadorCarrito === "function") {
                            actualizarContadorCarrito();
                        }

                        // 2. Mostramos el Toast del Layout
                        if (typeof mostrarNotificacion === "function") {
                            mostrarNotificacion("¡Producto añadido al pedido!");
                        }
                    },
                    error: function () {
                        if (typeof mostrarNotificacion === "function") {
                            mostrarNotificacion("Hubo un error al añadir el producto", true);
                        }
                    }
                });
            });
        });
    </script>
}