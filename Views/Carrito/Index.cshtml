@model BaseConLogin.Models.CarritoSession

@{
    ViewData["Title"] = "Mi Carrito de Compra";
    var tiendaIdConst = Model.TiendaId ?? 0;
    @ViewBag.TiendaId;
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fa-solid fa-cart-shopping me-2 text-primary"></i>@ViewData["Title"]</h2>
        <a class="btn btn-outline-secondary rounded-pill shadow-sm" href="/">
            <i class="fa-solid fa-arrow-left me-1"></i> Continuar comprando
        </a>
    </div>

    <div class="card shadow-sm border-0 p-4 mb-4">
        <div id="carrito-container">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-3">
        <button class="btn btn-link text-muted" onclick="vaciarCarrito()">Vaciar carrito</button>
        <form asp-controller="Checkout" asp-action="Confirmar" method="post">
            <button type="submit" id="btn-finalizar" class="btn btn-success btn-lg px-5 rounded-pill fw-bold shadow-sm" style="display:none;">
                Finalizar pedido <i class="fa-solid fa-chevron-right ms-2"></i>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const tiendaId = @tiendaIdConst;
        let debounceTimers = {};

        // Carga inicial
        async function cargarCarrito() {
            const res = await fetch(`/carrito/obtener?tiendaId=${tiendaId}`);
            const carrito = await res.json();
            renderCarrito(carrito);
        }

        function renderCarrito(carrito) {
            const container = document.getElementById('carrito-container');
            const btnFinalizar = document.getElementById('btn-finalizar');

            if (!carrito.items || carrito.items.length === 0) {
                container.innerHTML = `<div class="text-center py-5"><p class="h5 text-muted">Tu carrito está vacío.</p></div>`;
                btnFinalizar.style.display = 'none';
                return;
            }

            btnFinalizar.style.display = 'block';
            let html = `
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th class="text-center" style="width:150px">Cantidad</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody>`;

            carrito.items.forEach(item => {
                html += `
                <tr id="row-${item.productoBaseId}">
                    <td>
                        <div class="fw-bold">${item.nombre}</div>
                        <small class="badge bg-light text-dark border">${item.tipoProducto === 0 ? 'Físico' : 'Digital'}</small>
                    </td>
                    <td>
                        <input type="number" min="1" value="${item.cantidad}"
                               onchange="updateQty(${item.productoBaseId}, this.value)"
                               class="form-control form-control-sm text-center rounded-pill">
                    </td>
                    <td class="text-end">${formatEuro(item.precioUnitario)}</td>
                    <td class="text-end fw-bold text-primary">${formatEuro(item.precioUnitario * item.cantidad)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="eliminarItem(${item.productoBaseId})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });

            html += `</tbody></table></div>
                    <div class="text-end mt-3">
                        <span class="h5 me-3 text-muted">Total:</span>
                        <span class="h3 fw-bold text-primary">${formatEuro(carrito.total)}</span>
                    </div>`;

            container.innerHTML = html;
        }

        function formatEuro(val) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val);
        }

        function updateQty(id, qty) {
            if (qty < 1) return;
            clearTimeout(debounceTimers[id]);
            debounceTimers[id] = setTimeout(async () => {
                const res = await fetch('/carrito/actualizar', {
                    method: 'POST',
                    headers: {'Content-Type':'application/x-www-form-urlencoded'},
                    body: `productoBaseId=${id}&cantidad=${qty}&tiendaId=${tiendaId}`
                });
                renderCarrito(await res.json());
                if(window.actualizarContadorCarrito) actualizarContadorCarrito();
            }, 400);
        }

        async function eliminarItem(id) {
            if(!confirm("¿Quitar producto?")) return;
            const res = await fetch('/carrito/eliminar', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: `productoBaseId=${id}&tiendaId=${tiendaId}`
            });
            renderCarrito(await res.json());
            if(window.actualizarContadorCarrito) actualizarContadorCarrito();
        }

        async function vaciarCarrito() {
            if(!confirm("¿Vaciar todo el carrito?")) return;
            const res = await fetch('/carrito/vaciar', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: `tiendaId=${tiendaId}`
            });
            renderCarrito(await res.json());
            if(window.actualizarContadorCarrito) actualizarContadorCarrito();
        }

        cargarCarrito();
    </script>
}